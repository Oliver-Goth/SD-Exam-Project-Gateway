name: PR Validation - Code Quality & Security

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  # Code quality checks
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Shallow clones should be disabled for better analysis

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Run Checkstyle
        run: |
          echo "Running code style checks..."
          # Add checkstyle plugin to pom.xml if not present
          for service in customer-service ordering-service delivery-service fulfillment-service financial-service restaurant-service gateway; do
            if [ -d "$service" ]; then
              echo "Checking $service..."
              cd $service
              mvn checkstyle:check || echo "Checkstyle warnings in $service"
              cd ..
            fi
          done
        continue-on-error: true

      - name: Run SpotBugs (Static Analysis)
        run: |
          echo "Running static code analysis..."
          for service in customer-service ordering-service delivery-service fulfillment-service financial-service restaurant-service gateway; do
            if [ -d "$service" ]; then
              echo "Analyzing $service..."
              cd $service
              mvn compile spotbugs:spotbugs || true
              cd ..
            fi
          done
        continue-on-error: true

  # Security vulnerability scanning
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Run OWASP Dependency Check
        run: |
          echo "Scanning for known vulnerabilities in dependencies..."
          for service in customer-service ordering-service delivery-service fulfillment-service financial-service restaurant-service gateway; do
            if [ -d "$service" ]; then
              echo "Scanning $service..."
              cd $service
              mvn org.owasp:dependency-check-maven:check || echo "Vulnerabilities found in $service"
              cd ..
            fi
          done
        continue-on-error: true

      - name: Upload dependency check reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-reports
          path: "**/target/dependency-check-report.html"
          retention-days: 30

  # Dockerfile linting
  dockerfile-lint:
    name: Dockerfile Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint on all Dockerfiles
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "*/Dockerfile"
          recursive: true
          failure-threshold: warning

  # Check for secrets in code
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # Check code coverage
  test-coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Run tests with coverage
        run: |
          echo "Generating test coverage reports..."
          for service in customer-service ordering-service delivery-service fulfillment-service financial-service restaurant-service gateway; do
            if [ -d "$service" ]; then
              echo "Testing $service..."
              cd $service
              mvn clean test jacoco:report || echo "Tests failed in $service"
              cd ..
            fi
          done

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: "**/target/site/jacoco"
          retention-days: 30

      - name: Comment coverage on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Test Coverage Report \n\nCoverage reports have been generated and uploaded as artifacts. Please review them to ensure adequate test coverage.'
            })

  # PR summary
  pr-validation-summary:
    name: PR Validation Summary
    needs:
      [code-quality, security-scan, dockerfile-lint, secret-scan, test-coverage]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## PR Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfile Lint | ${{ needs.dockerfile-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Coverage | ${{ needs.test-coverage.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.secret-scan.result }}" == "failure" ]]; then
            echo "PR validation failed - Secrets detected in code!"
            exit 1
          fi

          echo "PR validation checks completed"
